<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Acessibilidade em Transporte Público</title>
    <link rel="icon" href="../assets/imgs/logoPreta.png">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/dashboards.css">
    <script src="../js/sessao.js"></script>
</head>

<body onload="validarSessao()">
    <div class="dashboard">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <img src="../assets/imgs/logo.svg" alt="" width="120px">
                </div>
            </div>

            <nav class="nav-menu">
                <a href="perfil.html" class="nav-item">
                    <i class="fa fa-user-circle-o"></i>
                    <span>Perfil</span>
                </a>
                <a href="painel.html" class="nav-item" id="menuPainel" style="display: none;">
                    <i class="fas fa-cogs"></i>
                    <span>Painel</span>
                </a>
                <a href="mural.html" class="nav-item active">
                    <i class="fas fa-chart-bar"></i>
                    <span>Dashboard</span>
                </a>
                <a href="relatorios.html" class="nav-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Relatórios</span>
                </a>
                <a href="../index.html" class="nav-item" id="sair">
                    <i class="fa-solid fa-door-open"></i>
                    <span onclick="limparSessao()">Sair</span>
                </a>
            </nav>
        </aside>

        <div class="main-content">
            <header class="header">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="nav-toggle" aria-label="abrir menu">
                        <div class="hamburger-line"></div>
                        <div class="hamburger-line"></div>
                        <div class="hamburger-line"></div>
                    </button>
                    <h1>Dashboard</h1>
                </div>
            </header>

            <main class="content">
                <div class="stats-grid">
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-bus"></i>
                            </div>
                            <div class="stat-title">Ônibus Acessíveis em SP</div>
                        </div>
                        <div class="stat-value" id="frotaAcessivel_valor">--</div>
                        <div class="stat-subtitle">da frota total</div>
                        <span class="stat-change" id="frotaAcessivel_variacao"></span>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-title">Elevadores Inoperantes</div>
                        </div>
                        <div class="stat-value" id="elevadoresInoperantes_valor">--</div>
                        <div class="stat-subtitle">em estações de metrô</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="stat-title">Minhas Reclamações</div>
                        </div>
                        <div class="stat-value" id="reclamacoes_valor">--</div>
                        <div class="stat-subtitle">registradas por você</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="stat-title">Frota Operando</div>
                        </div>
                        <div class="stat-value" id="veiculosOperando_valor">--</div>
                        <div class="stat-subtitle">veículos totalmente acessíveis</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <h3 class="chart-title">Evolução da Acessibilidade (2019-2024)</h3>
                        <div class="chart-container">
                            <canvas id="evolutionChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <h3 class="chart-title">Distribuição por Nível de Acessibilidade</h3>
                        <div class="chart-container">
                            <canvas id="distributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Variáveis globais para armazenar as instâncias dos gráficos
        let evolutionChartInstance = null;
        let distributionChartInstance = null;

        // Inicializa quando a página carregar
        document.addEventListener('DOMContentLoaded', function () {
            // Cria os gráficos vazios primeiro
            inicializarGraficosVazios();
            
            // Busca os dados do banco
            carregarDadosDashboard();

            // Atualiza os dados a cada 30 segundos
            setInterval(carregarDadosDashboard, 30000);
        });

        // 1. Função que cria os gráficos (vazios inicialmente)
        function inicializarGraficosVazios() {
            // Configuração do Gráfico de Barras (Evolução)
            const ctx1 = document.getElementById('evolutionChart');
            if (ctx1) {
                evolutionChartInstance = new Chart(ctx1.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['2019', '2020', '2021', '2022', '2023', '2024'],
                        datasets: [{
                            label: '% Veículos Totalmente Acessíveis',
                            data: [], // Começa vazio
                            backgroundColor: '#3b82f6',
                            borderColor: '#2563eb',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100, // Eixo Y vai até 100%
                                ticks: { callback: (value) => value + '%' }
                            },
                            x: { grid: { display: false } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // Configuração do Gráfico de Rosca (Distribuição)
            const ctx2 = document.getElementById('distributionChart');
            if (ctx2) {
                distributionChartInstance = new Chart(ctx2.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Totalmente Acessível', 'Parcialmente Acessível', 'Não Acessível', 'Em Adaptação'],
                        datasets: [{
                            data: [], // Começa vazio
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#6366f1'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { padding: 20, usePointStyle: true }
                            }
                        }
                    }
                });
            }
        }

        // 2. Função que busca os dados no Back-end
        function carregarDadosDashboard() {
            // Pega o ID do usuário salvo na sessão (Login)
            const idUsuario = sessionStorage.getItem("ID_USUARIO");

            if (!idUsuario) {
                console.warn("Usuário não está logado ou ID não encontrado!");
                // Se quiser redirecionar para login:
                // window.location = "../login.html";
                return;
            }

            console.log("Buscando dados para o usuário ID:", idUsuario);

            // Passa o ID na URL
            fetch(`/dashboard/obterMetricas?idUsuario=${idUsuario}`)
                .then(response => {
                    if (response.status === 204) {
                        console.log("Nenhum dado encontrado.");
                        return {};
                    }
                    if (!response.ok) {
                        throw new Error(`Erro na API: ${response.status}`);
                    }
                    return response.json();
                })
                .then(dados => {
                    if (Object.keys(dados).length > 0) {
                        console.log("Dados recebidos:", dados);
                        atualizarCards(dados);
                        atualizarGraficos(dados);
                    }
                })
                .catch(error => {
                    console.error("Erro ao obter métricas:", error);
                });
        }

        // 3. Atualiza os números dos Cards
        function atualizarCards(dados) {
            // KPI 1
            const cardFrota = document.getElementById('frotaAcessivel_valor');
            if (cardFrota) cardFrota.textContent = dados.frota_acessivel;

            // KPI 2
            const cardElev = document.getElementById('elevadoresInoperantes_valor');
            if (cardElev) cardElev.textContent = dados.elevadores_inoperantes;

            // KPI 3
            const cardReclamacoes = document.getElementById('reclamacoes_valor');
            if (cardReclamacoes) cardReclamacoes.textContent = dados.reclamacoes_registradas;

            // KPI 4
            const cardVeiculos = document.getElementById('veiculosOperando_valor');
            if (cardVeiculos) cardVeiculos.textContent = dados.veiculos_operando;
        }

        // 4. Atualiza os gráficos com os dados novos
        function atualizarGraficos(dados) {
            // Atualiza Evolução (Barras)
            if (evolutionChartInstance && dados.evolucao_acessibilidade) {
                evolutionChartInstance.data.datasets[0].data = dados.evolucao_acessibilidade;
                evolutionChartInstance.update();
            }

            // Atualiza Distribuição (Rosca)
            if (distributionChartInstance && dados.distribuicao_acessibilidade) {
                distributionChartInstance.data.datasets[0].data = dados.distribuicao_acessibilidade;
                distributionChartInstance.update();
            }
        }

        // --- Lógica do Menu Hamburger (Sidebar) ---
        const navToggle = document.querySelector('.nav-toggle');
        const sidebar = document.getElementById('sidebar');

        if (navToggle && sidebar) {
            navToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                sidebar.classList.toggle('open');
            });

            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    sidebar.classList.remove('open');
                });
            });

            document.addEventListener('click', (e) => {
                if (!sidebar.contains(e.target) && !navToggle.contains(e.target) && sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                }
            });
        }
    </script>
</body>

</html>